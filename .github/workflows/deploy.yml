name: Deploy application to production server

on:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy to Hostinger
    runs-on: ubuntu-latest
    steps:
      # - name: Add Server to known_hosts
      #   run: |
      #     mkdir -p ~/.ssh
      #     ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts || true

      - name: Running deployment artifacts
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd domains/stundz.com/public_html # IMPORTANT: Change this to your project's root directory on Hostinger
            git pull origin main

            echo "📦 Installing Composer dependencies..."
            composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader

            # echo "🌐 Building frontend assets..."
            # if command -v npm &> /dev/null
            # then
            #     npm install
            #     npm run build
            # else
            #     echo "⚠️ npm not found, skipping frontend build. Install Node.js on your server if needed."
            # fi

            if [ ! -f .env ]; then
                echo "📄 Creating .env file from .env.example..."
                cp .env.example .env
                echo "🔑 Generating application key..."
                php artisan key:generate
            else
                echo "✅ .env file already exists."
            fi

            echo "🗄️ Running database migrations..."
            php artisan migrate --force

            echo "⚡ Optimizing application..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "✅ Deployment finished successfully!"
